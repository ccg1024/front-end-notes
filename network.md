# HTTPS

Https又叫（HTTP over TLS）。TLS--transport layer security。基本的TLS通信方式如下。

- 客户端发送一个`ClientHello`消息到服务器端，消息中同时包含了它的 Transport Layer Security (TLS) 版本，可用的加密算法和压缩算法。

- 服务器端向客户端返回一个`ServerHello`消息，消息中包含了服务器端的 TLS 版本，服务器所选择的加密和压缩算法，以及数字证书认证机构（Certificate Authority，缩写 CA）签发的服务器公开证书，证书中包含了公钥。客户端会使用这个公钥加密接下来的握手过程，直到协商生成一个新的对称密钥。证书中还包含了该证书所应用的域名范围（Common Name，简称 CN），用于客户端验证身份。

- 客户端根据自己的信任CA列表，验证服务器端的证书是否可信。如果认为可信，客户端会生成一串伪随机数，使用服务器的公钥加密它。这串随机数会被用于生成新的对称密钥

- 服务器端使用自己的私钥解密上面提到的随机数，然后使用这串随机数生成自己的对称主密钥

- 客户端发送一个`Finished`消息给服务器端，使用对称密钥加密这次通讯的一个散列值

- 服务器端生成自己的hash值，然后解密客户端发送来的信息，检查这两个值是否对应。如果对应，就向客户端发送一个`Finished`消息，也使用协商好的对称密钥加密

> 但HTTPS并不是完全安全的，依旧可以被中间人攻击。

### SSL剥离

很多网站能够同时使用HTTP与HTTPS访问，SSL剥离能够阻止用户通过HTTPS的方式访问服务器。DNS是基于UDP协议的。通过劫持DNS响应，就可以实现中间人。

### HSTS

解决SSL的方式，强制浏览器使用HTTPS访问服务器，但有个缺陷，第一次访问服务器的时候不知道是不是强制使用，通常浏览器会有个记录表，指明那些域名强制使用HTTPS通信。

### 伪造证书攻击

攻击者劫持了DNS响应，用户以对方服务器为目标服务器。同时，对方服务器有用户认为合法的证书。

> 这就只能是证书发布机构不乱发证书

### HPKP

HPKP在HSTS基础上更进一步，直接在返回头中存放服务器的公钥指纹，一旦指纹与接受到的公钥不对，则可认为被攻击。但同样依赖首次访问。所以浏览器本身也自带一些HPKP列表。同HSTS。

> 但实际上HPKP技术会带来一些完全问题，同时配置繁琐，一旦错误就会导致证书认证失败，过期时间内无法有效恢复。所以Chrome72就彻底移除HPKP。
